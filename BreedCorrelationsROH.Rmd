---
title: "Dogs Paper Additional Info"
author: "Shengmiao Huang"
date: "2025-08-14"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
library(dplyr)
library(janitor)
library(stringr)
library(ggplot2)
library(tidyr)
library(ggrepel)
library(patchwork)
```

```{r}
xls_path <- "Supplement Tables.xlsx"
excel_sheets(xls_path)

# Load S10 and S11
s10 <- read_excel(xls_path, sheet = "S10 - ROH Summary") %>%
  clean_names()  # snake_case column names

s11 <- read_excel(xls_path, sheet = "S11- FROH summary") %>%
  clean_names()

glimpse(s10)
glimpse(s11)

# S10 column names
s10_use <- s10 %>%
  rename(
    breed_common_name = breed_common_name,
    breed_group       = breed_group,
    nroh              = n_total,
    sroh_bp           = total,
    sroh_mbp          = s_roh_in_mbp,
    froh              = froh
)
# s10 group by breeds
s10_use %>%
  count(breed_common_name, sort = TRUE) %>%
  print(n = 50)

#palette for the clades
cbPalette = c("Ancient Spitz" = "#0072B2",  "ChineseIndigenousDogs" = "#882255", "Herding" = "#009E73", "Mastiff-like" = "gold4", "Retriever" = "plum", "Scent Hound" = "#F2C695FF", "Sight Hound" = "#06141FFF", "SmallTerriers" = "#7EBAC2FF", "Spaniel" = "#742C14FF",  "Terriers"  =  "#E48C2AFF", "ToyDogs" = "#14454CFF", "VillageDogs" = "#657060FF" , "WorkingDog" = "#D1B79EFF")
```


# Within Breed correlations

```{r}
# Within-breed correlation (nROH vs sROH) only for breeds with >= 10 individuals
breed_corr <- s10_use %>%
  group_by(breed_common_name) %>%
  summarise(
    n_individuals   = n(),
    cor_nroh_sroh   = cor(nroh, sroh_mbp, method = "pearson", use = "complete.obs"),
    slope_nroh_sroh = coef(lm(sroh_mbp ~ nroh))[2]
  ) %>%
  filter(n_individuals >= 10) %>% 
  arrange(desc(n_individuals))

print(breed_corr) 

```

```{r}
# Filter to breeds with >=10 individuals
breed_data10 <- s10_use %>%
  group_by(breed_common_name) %>%
  filter(n() >= 10)

# Calculate R² and p-values for each breed
stats_per_breed <- breed_data10 %>%
  group_by(breed_common_name) %>%
  do({
    fit <- lm(sroh_mbp ~ nroh, data = .)
    smr <- summary(fit)
    tibble(
      r2   = smr$adj.r.squared,
      pval = coef(smr)[2, 4]
    )
  }) %>%
  mutate(
    label = paste0("R²=", round(r2, 2), "\n",
                   "p=", signif(pval, 2))
  )

ggplot(breed_data10, aes(x = nroh, y = sroh_mbp)) +
  geom_point(alpha = 0.6, color = "steelblue") +
  geom_smooth(method = "lm", se = FALSE, color = "darkred") +
  facet_wrap(~ breed_common_name, scales = "free") +
  geom_text(data = stats_per_breed, 
            aes(x = -Inf, y = Inf, label = label), 
            hjust = -0.1, vjust = 1.1, inherit.aes = FALSE, size = 4) +
  theme_bw() +
  theme(axis.text = element_text(size = 18), 
        #plot.title=element_text(size=26, face = "bold", hjust=0.5), 
        axis.title=element_text(size=20),
        legend.title=element_text(size=20), 
        legend.text=element_text(size=18),
        strip.text = element_text(size=14)) + 
  labs(
    x = "Number of ROH (nROH)",
    y = "Sum of ROH (sROH, Mbp)",
    #title = "Within-breed correlations of nROH vs sROH (breeds with >= 10 samples)"
  )

```
- To assess the relationship between the number of runs of homozygosity (nROH) and the total length of homozygous segments (sROH), we first analyzed patterns within individual breeds with at least ten samples, and found that all breeds exhibited a positive correlation between nROH and sROH, although the strength of this relationship varied markedly. For example, Tibetan Mastiff (China) displayed a particularly strong association (r²=0.96), with each additional ROH corresponding to about 3.9 Mb of homozygous sequence, while Bernese Mountain Dog showed a much weaker correlation (r²=0.14) with a slope of about 2.3 Mb per ROH. Other breeds, such as Portuguese Water Dog (r²=0.78, slope = 6.6 Mb/ROH) and Belgian Tervuren (r²=0.83, slope = 7.2 Mb/ROH), exhibited relatively steep slopes, whereas Yorkshire Terrier (r²=0.43, slope = 1.8 Mb/ROH) fell at the lower end of the spectrum. 

- These results shows that while the nROH–sROH relationship is consistently positive across breeds, the magnitude of the effect varies considerably, reflecting heterogeneity in the typical length distribution of ROHs. Steeper slopes are consistent with the presence of longer ROHs, indicative of recent inbreeding, whereas shallower slopes likely reflect the accumulation of shorter ROHs generated by older bottlenecks and sustained small effective population sizes.
```{r}
# single plot
ggplot(breed_data10, aes(x = nroh, y = sroh_mbp, color = breed_common_name)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal() +
  labs(
    x = "Number of ROH (nROH)",
    y = "Sum of ROH (sROH, Mbp)",
    title = "Within-breed correlations of nROH vs sROH",
    color = "Breed"
  )
```

# Between breed correlation

```{r}
breed_means <- s10_use %>%
  group_by(breed_common_name, breed_group) %>%
  summarise(
    n_individuals = n(),
    mean_nroh     = mean(nroh, na.rm = TRUE),
    mean_sroh     = mean(sroh_mbp, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r}
cor_between_breeds <- cor(
  breed_means$mean_nroh,
  breed_means$mean_sroh,
  method = "pearson",
  use = "complete.obs"
)
breed_lm <- lm(mean_sroh ~ mean_nroh, data = breed_means)
slope_between_breed     <- coef(breed_lm)[2]

cor_between_breeds
slope_between_breed

```

```{r}
ggplot(breed_means, aes(x = mean_nroh, y = mean_sroh)) +
  geom_point(alpha = 0.7, color = "steelblue") +
  geom_smooth(method = "lm", se = FALSE, color = "darkred") +
  theme_bw() +
  theme(axis.text = element_text(size = 18), 
        #plot.title=element_text(size=26, face = "bold", hjust=0.5), 
        axis.title=element_text(size=20),
        legend.title=element_text(size=20), 
        legend.text=element_text(size=18),
        strip.text = element_text(size=14)) + 
  labs(
    x = "Mean nROH (per breed)",
    y = "Mean sROH (Mbp, per breed)",
    title = "Between-breed correlation of nROH and sROH"
  )
```

## Between clade

```{r}
breed_means_shaped <- breed_means %>%
  drop_na(mean_nroh, mean_sroh, breed_group, breed_common_name) %>%
  group_by(breed_group) %>%
  arrange(breed_common_name, .by_group = TRUE) %>%
  mutate(shape_id = (dense_rank(breed_common_name) - 1) %% 15) %>%  # 0..14 per group
  ungroup()

fit <- lm(mean_sroh ~ mean_nroh, data = breed_means_shaped)
breed_means_shaped$resid <- residuals(fit)

# Define outliers as |residual| > 2 × SD of residuals
threshold <- 2 * sd(breed_means_shaped$resid, na.rm = TRUE)
outliers <- breed_means_shaped %>%
  filter(abs(resid) > threshold) %>%
  select(breed_common_name, breed_group, mean_nroh, mean_sroh, resid, shape_id)


# Plot with colors by breed group
ggplot(breed_means_shaped, aes(x = mean_nroh, y = mean_sroh, color = breed_group, shape = factor(shape_id))) +
  geom_point(size = 3, alpha = 0.8) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE, color = "black") +
  scale_shape_manual(values = 0:14) +
  scale_colour_manual(name = "Clade", values = cbPalette) +
  geom_text_repel(data = outliers,
                  aes(label = breed_common_name),
                  size = 3, show.legend = FALSE) +
  theme_bw() +
  theme(axis.text = element_text(size = 18), 
        #plot.title=element_text(size=26, face = "bold", hjust=0.5), 
        axis.title=element_text(size=20),
        legend.title=element_text(size=20), 
        legend.text=element_text(size=18),
        strip.text = element_text(size=14)) + 
  labs(
    x = "Mean nROH (per breed)",
    y = "Mean sROH (Mbp, per breed)",
    title = "Between-breed correlation of nROH and sROH"
  )

# Plot with colors by breed group
ggplot(breed_means_shaped, aes(y = mean_nroh, x = mean_sroh, color = breed_group)) +
  geom_point(size = 3, alpha = 0.8) +
  geom_abline(slope=1, intercept = 0) +
  #geom_smooth(aes(group = 1), method = "lm", se = FALSE, color = "black") +
  facet_wrap(~ breed_group, scales = "fixed") +
  scale_colour_manual(name = "Clade", values = cbPalette) +
  theme_bw() +
  theme(axis.text = element_text(size = 18), 
        #plot.title=element_text(size=26, face = "bold", hjust=0.5), 
        axis.title=element_text(size=20),
        legend.title=element_text(size=20), 
        legend.text=element_text(size=18),
        strip.text = element_text(size=14)) + 
  labs(
    y = "Mean nROH (per breed)",
    x = "Mean sROH (Mbp, per breed)",
    #title = "Between-breed correlation of nROH and sROH"
  )
```
- Different breeds within a same clade have same color but different shapes.

- At the between-breed level, averaging values across individuals, we observed a strong global correlation between mean nROH and mean sROH (r²=0.59, p < 2.2e-16). The fitted regression slope indicated that, on average, each additional ROH corresponds to a 2.782974 Mb increase in homozygous sequence, suggesting that genome-wide patterns of homozygosity are highly predictable from the number of ROHs. 

- Importantly, this relationship was not homogeneous across clades. 

## Separate fits

```{r}
ggplot(breed_means_shaped, aes(x = mean_nroh, y = mean_sroh, color = breed_group, shape = factor(shape_id))) +
  geom_point(size = 3, alpha = 0.85) +
  # one lm line PER group (same colors as points)
  geom_smooth(aes(group = breed_group, color = breed_group),
              method = "lm", se = FALSE, linewidth = 1) +
  scale_shape_manual(values = 0:14) +
  geom_text_repel(data = outliers,
                  aes(label = breed_common_name),
                  size = 3, show.legend = FALSE) +
  theme_minimal() +
  labs(
    x = "Mean nROH (per breed)",
    y = "Mean sROH (Mbp, per breed)",
    title = "Between-breed nROH vs sROH with group-specific linear fits",
    color = "Breed Group"
  )
```
- A linear model including an interaction between nROH and breed group revealed significant group-level differences (interaction p=0.016). Herding, Mastiff-like, and Sight Hound clades all exhibited significantly steeper slopes than the baseline group, with increases of about 2.6–2.7 Mb/ROH, indicating that in these clades, each additional ROH tends to be longer on average.

```{r}
outliers <- breed_means_shaped %>%
  filter(abs(resid) > threshold) %>%
  pull(breed_common_name)

breed_means_flagged <- breed_means_shaped %>%
  mutate(is_outlier = ifelse(breed_common_name %in% outliers, "Outlier", "Non-outlier"))

# Left plot: with outliers
p1 <- ggplot(breed_means_flagged,
             aes(x = mean_nroh, y = mean_sroh,
                 color = breed_group, shape = factor(shape_id))) +
  geom_point(size = 3, alpha = 0.85) +
  geom_smooth(aes(group = breed_group, color = breed_group),
              method = "lm", se = FALSE, linewidth = 1) +
  scale_shape_manual(values = 0:14) +
  guides(shape = "none") +
  theme_minimal() +
  labs(
    title = "With outliers",
    x = "Mean nROH (per breed)",
    y = "Mean sROH (Mbp, per breed)",
    color = "Breed Group"
  )

# Right plot: without outliers
p2 <- ggplot(filter(breed_means_flagged, is_outlier == "Non-outlier"),
             aes(x = mean_nroh, y = mean_sroh,
                 color = breed_group, shape = factor(shape_id))) +
  geom_point(size = 3, alpha = 0.85) +
  geom_smooth(aes(group = breed_group, color = breed_group),
              method = "lm", se = FALSE, linewidth = 1) +
  scale_shape_manual(values = 0:14) +
  guides(shape = "none") +
  theme_minimal() +
  labs(
    title = "Without outliers",
    x = "Mean nROH (per breed)",
    y = "Mean sROH (Mbp, per breed)",
    color = "Breed Group"
  )

# Combine side by side
(p1 | p2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")

```

- When examining clade-level regressions of mean nROH against mean sROH, we observed that several outlier breeds disproportionately influenced the fitted slopes. In the full dataset, certain clades (e.g. Ancient Spitz, Herding, and Mastiff-like) exhibited markedly steeper regression lines, largely driven by a handful of breeds with unusually high sROH values relative to their nROH counts. For example, Bulldog acted as strong positive outliers, pulling the clade-level slope upwards.

- After removing these outlier breeds, the regression lines across clades became much more consistent in slope. This demonstrates that the apparent heterogeneity in clade-level relationships was not uniform across all members of a clade, but instead was being driven by specific breeds with extreme ROH profiles. In other words, the slope differences between clades are largely attributable to a few breeds undergoing particularly severe founder events or bottlenecks, rather than to a systematic difference across the entire clade.

```{r}
# Linear fit
model <- lm(mean_sroh ~ mean_nroh * breed_group, data = breed_means)

summary(model)
anova(model)
```

```{r}
# Model without outliers
breed_means_no_out <- breed_means_flagged %>%
  filter(is_outlier == "Non-outlier")

model_no_out <- lm(mean_sroh ~ mean_nroh * breed_group, data = breed_means_no_out)
summary(model_no_out)
anova(model_no_out)
```

-   mean_nroh: correlation between sroh and nroh are strong
-   breed group: interceptions
-   mean_nroh:breed_group : the slopes
-   Limitations: unequal sample sizes across breeds
